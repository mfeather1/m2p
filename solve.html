<!doctype html>
<html>
<head>
 <title> Min2Phase Solver </title>
 <meta name="author" content="Michael Feather">
 <meta name="robots" content="nofollow">
 <link rel=icon href=mini_cube.png type=image/png>
 <link rel="stylesheet" type="text/css" href="style.css">
 <meta name=viewport content="width=device-width, initial-scale=1">
 <script src=min2phase.js></script>
 <script src=AnimCube3.js></script>
</head>
<body>
<center>
<style> input { height:22px; width:22px;} </style>
<table>
<tr><td height=8></tr>
<tr><td valign=top>
<font size=+2> Min2Phase Solver </font>
<table border=0 style=line-height:0>
  <tr height=8>
  <tr>
    <td colspan=4></td>
    <td> <input id=f0 type=button onclick=set_color(this)> </td>
    <td> <input id=f1 type=button onclick=set_color(this)> </td>
    <td> <input id=f2 type=button onclick=set_color(this)> </td>
    <td colspan=2>
    <td colspan=5 rowspan=3 align=center>
      <table border=0>
        <tr height=5> </tr>
        <tr>
          <td width=3>
          <td> <input type=button id=R onclick=select_color(this) 
                      style="background-color:red;"> </td>
          <td> <input type=button id=Y onclick=select_color(this) 
                      style="background-color:yellow;"> </td>
          <td> <input type=button id=B onclick=select_color(this) 
                      style="background-color:blue;"> </td>
        </tr>
        <tr>
          <td>
          <td> <input type=button id=O onclick=select_color(this) 
                      style="background-color:orange"> </td>
          <td> <input type=button id=W onclick=select_color(this) 
                      style="background-color:white"> </td>
          <td> <input type=button id=G onclick=select_color(this) 
                      style="background-color:green"> </td>
        </tr>
      </table>
    </td>
  </tr>
  <tr> 
    <td colspan=4></td>
    <td> <input id=f3 type=button onclick=set_color(this)> </td>
    <td> <input id=f4 type=button onclick=set_color(this)> </td> 
    <td> <input id=f5 type=button onclick=set_color(this)> </td>
  </tr>
  <tr> 
    <td colspan=4></td>
    <td> <input id=f6 type=button onclick=set_color(this)> </td>
    <td> <input id=f7 type=button onclick=set_color(this)> </td>
    <td> <input id=f8 type=button onclick=set_color(this)> </td>
  </tr>
  <tr height=10> </tr>
  <tr>
    <td> <input id=f9 type=button onclick=set_color(this)> </td>
    <td> <input id=f10 type=button onclick=set_color(this)> </td>
    <td> <input id=f11 type=button onclick=set_color(this)> </td>
    <td width=12> </td>
    <td> <input id=f12 type=button onclick=set_color(this)> </td>
    <td> <input id=f13 type=button onclick=set_color(this)> </td>
    <td> <input id=f14 type=button onclick=set_color(this)> </td>
    <td width=12> </td>
    <td> <input id=f15 type=button onclick=set_color(this)> </td>
    <td> <input id=f16 type=button onclick=set_color(this)> </td>
    <td> <input id=f17 type=button onclick=set_color(this)> </td>
    <td width=12> </td>
    <td> <input id=f18 type=button onclick=set_color(this)> </td>
    <td> <input id=f19 type=button onclick=set_color(this)> </td>
    <td> <input id=f20 type=button onclick=set_color(this)> </td>
  </tr>
  <tr>
    <td> <input id=f21 type=button onclick=set_color(this)> </td>
    <td> <input id=f22 type=button onclick=set_color(this)> </td>
    <td> <input id=f23 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f24 type=button onclick=set_color(this)> </td>
    <td> <input id=f25 type=button onclick=set_color(this)> </td>
    <td> <input id=f26 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f27 type=button onclick=set_color(this)> </td>
    <td> <input id=f28 type=button onclick=set_color(this)> </td>
    <td> <input id=f29 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f30 type=button onclick=set_color(this)> </td>
    <td> <input id=f31 type=button onclick=set_color(this)> </td>
    <td> <input id=f32 type=button onclick=set_color(this)> </td>
  </tr>
  <tr>
    <td> <input id=f33 type=button onclick=set_color(this)> </td>
    <td> <input id=f34 type=button onclick=set_color(this)> </td>
    <td> <input id=f35 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f36 type=button onclick=set_color(this)> </td>
    <td> <input id=f37 type=button onclick=set_color(this)> </td>
    <td> <input id=f38 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f39 type=button onclick=set_color(this)> </td>
    <td> <input id=f40 type=button onclick=set_color(this)> </td>
    <td> <input id=f41 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f42 type=button onclick=set_color(this)> </td>
    <td> <input id=f43 type=button onclick=set_color(this)> </td>
    <td> <input id=f44 type=button onclick=set_color(this)> </td>
  </tr>
  <tr height=10> </tr>
  <tr>
    <td colspan=4></td>
    <td> <input id=f45 type=button onclick=set_color(this)> </td>
    <td> <input id=f46 type=button onclick=set_color(this)> </td>
    <td> <input id=f47 type=button onclick=set_color(this)> </td>
  </tr>
  <tr>
    <td colspan=4></td>
    <td> <input id=f48 type=button onclick=set_color(this)> </td>
    <td> <input id=f49 type=button onclick=set_color(this)> </td>
    <td> <input id=f50 type=button onclick=set_color(this)> </td>
  </tr>
  <tr>
    <td colspan=4></td>
    <td> <input id=f51 type=button onclick=set_color(this)> </td>
    <td> <input id=f52 type=button onclick=set_color(this)> </td>
    <td> <input id=f53 type=button onclick=set_color(this)> </td>
  </tr>
</table>

<table border=0>
  <tr height=14>
  <tr>
    <td> <button class="btn svw1" onclick="home()">Home</button> </td>
    <td width=5>
    <td> <button class="btn svw1" onclick="show()">Show</button> </td>
    <td width=5>
    <td> <button class="btn svw2" onclick="rand()">Random</button> </td>
    <td width=5>
    <td> <button class="btn svw1" onclick="solve()">Solve</button> </td>
  </tr>
  <tr height=10>
  <tr>
    <td> <button class="btn svw1" onclick="clera()">Clear</button> </td>
    <td width=5> </td>
    <td> <button class="btn svw1" onclick="help()">Help</button> </td>
    <td width=5> </td>
    <td valign=top colspan=3 style=text-align:right>
        Max Length
        <input type=text id=maxlen maxlength=5
         style="font-size:.9em; height:24px; width:40px; border:none;
           border-radius:10px; padding-left:8px; border-radius:15px" value=20>
    </td>
  </tr>
  <tr height=10>
  <tr> 
    <td colspan=8>
      <div id=btn>
      </div>
     </td>
  </tr>
</table>

</td><td width=5%><td id=tdc valign=top>
<div id=cube style=width:290px;height:290px
     ondblclick="event.stopPropagation()">
</div>
<br>
<div id=status style=width:300px></div>
</td>
</tr><tr height=8></tr></table>
Powered by <a target=_blank href=https://github.com/cs0x7f/min2phase.js>min2phase.js</a>.
<br><br>
<div id=back> </div>
<br><br>
<script>
"use strict";
var color;
var style;
var facelets;
var facelets_arr = [];
var cloze = 0;
var solution = [];
var acjs_removeListeners = [];
var solve_running = 0;
var CUBE_HOME   = "RRRRRRRRRGGGYYYBBBWWWGGGYYYBBBWWWGGGYYYBBBWWWOOOOOOOOO";
var CUBE_BLANK  = "LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL";
var config = init_config();
var worker;
main();
function main() {
  new_worker();
  var params = location.search.substr(1).split('&');
  for (var i=0; i < params.length; i++) {
    var p = params[i].split('=');
    if (typeof(p[1]) != 'undefined')
      window[p[0]] = p[1];
  }
  if (typeof(facelets) == 'undefined')
    facelets = CUBE_HOME;
  else {
    cloze = 1;
    if (facelets.length > 54)
      facelets = facelets.substr(0,54);
    if (facelets.length < 54)
      facelets = (facelets + CUBE_BLANK).substr(0,54);
    facelets = facelets.toUpperCase();
    var ftmp = facelets.split('');
    for (var i=0; i < 54; i++) {
      var f = ftmp[i];
      if ('WYORGB'.indexOf(f) == -1)
        ftmp[i] = 'L';
    }
    facelets = ftmp.join('');
  }
  update_layout();
  show_cube(0);
  if (cloze == 1)
    document.getElementById('back').innerHTML = '<a href="JavaScript:window.close()">Close</a>';
  else 
    document.getElementById('back').innerHTML = '<a href="javascript: history.go(-1)">Back</a>';
}
function new_worker() {
  worker = new Worker('min2phase.js');
  worker.addEventListener('message', ipc);
}
function ipc(e) {
  solve_running = 0;
  solution = e.data.solution;
  if (solution.length > 0) {
    if (solution.substr(0,5) != 'Error') {
      show_solution();
    }
    else {
      var err = err_msg(solution[6]);
      document.getElementById('status').innerHTML = err;
      document.getElementById('status').style.textAlign = 'left';
    }
  }
}
function err_msg(n) {
  var s;
  if      (n == 1) s = 'Invalid config';
  else if (n == 2) s = 'Missing edges';
  else if (n == 3) s = 'Flipped edge';
  else if (n == 4) s = 'Missing corners';
  else if (n == 5) s = 'Twisted corner';
  else if (n == 6) s = 'Parity error';
  else if (n == 7) s = 'Solution not found';
  else if (n == 8) s = 'Solution not found (8)';
  else s  = 'Unknown Error: ' + e;
  return s;
}
function update_layout() {
  facelets_arr = facelets.split('');
  for (var i=0; i < 54; i++) {
    document.getElementById('f' + i).style.backgroundColor = color_str(facelets_arr[i]);
  }
}
function select_color(f) { 
  color = f.id;
}
function set_color(f) { 
  if (typeof(color) != 'undefined') {
    facelets_arr[f.id.substr(1)] = color;
    f.style.backgroundColor = color_str(color);
  }
}
function show() {
  if (solve_running == 1)
    return;
  if (facelets != facelets_arr.join('')) {
    facelets = facelets_arr.join('');
    show_cube(1);
  }
}
function home() {
  if (solve_running == 1)
    return;
  facelets = CUBE_HOME;
  if (CUBE_HOME != facelets_arr.join('')) {
    update_layout();
    show_cube(1);
  }
}
function rand() {
  if (solve_running == 1)
    return;
  var r = min2phase.randomCube();
  facelets = cvt_from_m2p(r);
  console.log('m2p: ' + r);
  console.log('text: ' + facelets);
  update_layout();
  show_cube(1);
}
function clera() {
  if (solve_running == 1)
    return;
  facelets = CUBE_BLANK;
  if (CUBE_BLANK != facelets_arr.join('')) {
    update_layout();
    show_cube(1);
  }
}
function help() {
  window.open('solver_help.html');
}
function solve() {
  if (solve_running == 1 || facelets == CUBE_HOME)
    return;
  var c = cvt_to_m2p(facelets);
  var s = document.getElementById('maxlen').value;
  var n = (!isNaN(s) ? Number(s) : 20);
  solve_running = 1;
  worker.postMessage({'cube':c, 'maxlen':n});
  document.getElementById('status').style.textAlign = 'left';
  if (n < 20)
    show_stop_btn();
}
function show_stop_btn() {
  var b = 'Searching &nbsp; ';
  b += '<button class="btn svw1" onclick=stop_search()>Stop</button>';
  document.getElementById('status').innerHTML = b;
}
function stop_search() {
  worker.removeEventListener('message', ipc);
  worker.terminate();
  solve_running = 0;
  document.getElementById('status').innerHTML = 'Search stopped';
  new_worker();
}
function cvt_to_m2p(c) {
  var ix = [
     0, 1, 2, 3, 4, 5, 6, 7, 8,15,16,17,27,28,29,39,40,41,
    12,13,14,24,25,26,36,37,38,45,46,47,48,49,50,51,52,53,
     9,10,11,21,22,23,33,34,35,18,19,20,30,31,32,42,43,44
  ];
  c = c.split('');
  var U=c[4], D=c[49], L=c[22], R=c[28], F=c[25], B=c[31];
  for (var i=0; i < 54; i++) {
    if      (c[i] == U) c[i] = 'U';
    else if (c[i] == D) c[i] = 'D';
    else if (c[i] == L) c[i] = 'L';
    else if (c[i] == R) c[i] = 'R';
    else if (c[i] == F) c[i] = 'F';
    else if (c[i] == B) c[i] = 'B';
  }
  for (var i=0, f=''; i < 54; i++)
    f += c[ix[i]];
  return f;
}
function cvt_from_m2p(c) {
  var ix = [
     0, 1, 2, 3, 4, 5, 6, 7, 8,36,37,38,18,19,20, 9,10,11,
    45,46,47,39,40,41,21,22,23,12,13,14,48,49,50,42,43,44,
    24,25,26,15,16,17,51,52,53,27,28,29,30,31,32,33,34,35
  ];
  for (var i=0, f=[]; i < 54; i++)
    f[i] = c[ix[i]];
  for (var i=0; i < 54; i++) {
    if      (f[i] == 'U') f[i] = 'R';
    else if (f[i] == 'D') f[i] = 'O';
    else if (f[i] == 'F') f[i] = 'Y';
    else if (f[i] == 'B') f[i] = 'W';
    else if (f[i] == 'L') f[i] = 'G';
    else if (f[i] == 'R') f[i] = 'B';
  }
  return f.join('');
}
function show_solution() {
  var af = cvt_to_anim(facelets);
  console.log('acjs:' + af);
  console.log(solution);
  var sol = solution;
  acjs_removeListeners['cube']();
  AnimCube3("&id=cube&move=" + sol + "&facelets=" + af + config);
  document.getElementById('status').style.textAlign = 'center';
  solve_running = 0;
  clear_status();
}
function show_cube(n) {
  if (n) {
    clear_status();
    acjs_removeListeners['cube']();
  }
  var af = cvt_to_anim(facelets);
  AnimCube3("&id=cube&facelets=" + af + config);
}
function cvt_to_anim(c) {
  var ca = new Array(54);
  var to_anim = [
    6,7,8,3,4,5,0,1,2,45,48,51,46,49,52,47,50,53,12,24,
    36,13,25,37,14,26,38,18,30,42,19,31,43,20,32,44,11,
    10,9,23,22,21,35,34,33,15,27,39,16,28,40,17,29,41];
  for (var i=0; i < 54; i++)
    ca[i] = c[to_anim[i]];
  return(ca.join(''));
}
function color_str(c) {   
  if      (c == "W") return "white";
  else if (c == "Y") return "yellow";
  else if (c == "R") return "red";
  else if (c == "O") return "orange";
  else if (c == "B") return "blue";
  else if (c == "G") return "green";
  else if (c == "L") return "lightgray";
}
function init_config() {
  var s = '&fonttype=0';
  s += '&bgcolor=38383D';
  s += '&butbgcolor=baffc9';
  s += '&repeat=0';
  s += '&textsize=20';
  s += '&buttonheight=17';
  s += '&slidercolor=707070';
  s += '&sliderbgcolor=dddddd';
  s += '&snap=1';
  return s;
}
function clear_status() {
  document.getElementById('status').innerHTML = '';
}
</script>
</center>
</body>
</html>
